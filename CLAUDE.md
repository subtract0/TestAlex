# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Firebase Functions Development
```bash
# Install dependencies
cd functions && npm install

# Lint code
cd functions && npm run lint

# Start emulator for local development
cd functions && npm run serve
# Or from root: firebase emulators:start --only functions

# Deploy functions to Firebase
cd functions && npm run deploy
# Or from root: firebase deploy --only functions

# View function logs
cd functions && npm run logs
# Or from root: firebase functions:log
```

### Python Development (Local testing)
```bash
# Install Python dependencies
pip install -r requirements.txt

# Test CourseGPT locally
python main.py "What is forgiveness according to ACIM?"

# Manage OpenAI Assistant
python manage_assistant.py create --name "CourseGPT" --model gpt-4o
python manage_assistant.py update --prompt /data/CourseGPT.md
```

### Firebase Deployment
```bash
# Deploy all components
firebase deploy

# Deploy specific components
firebase deploy --only functions
firebase deploy --only hosting
firebase deploy --only firestore:rules,firestore:indexes
```

## Architecture Overview

### Core Platform
**ACIMguide** - A spiritual guidance platform powered by CourseGPT (OpenAI Assistant) providing authentic ACIM teachings through a web interface.

### Technology Stack
- **Frontend**: Vanilla HTML/CSS/JavaScript with Firebase SDK
- **Backend**: Firebase Cloud Functions (Node.js)
- **Database**: Firestore with real-time listeners
- **AI**: OpenAI Assistants API (CourseGPT) with ACIM knowledge base
- **Authentication**: Firebase Anonymous Auth
- **Hosting**: Firebase Hosting

### Key Components

#### 1. Firebase Cloud Functions (`functions/index.js`)
- **`chatWithAssistant`**: Main endpoint for CourseGPT conversations
  - Handles multilingual language detection
  - Implements rate limiting and token management
  - Manages OpenAI Assistant threads per user
  - Returns real-time responses with citations
- **`clearThread`**: Resets user conversation history
- Environment variables: `OPENAI_API_KEY`, `ASSISTANT_ID`, `VECTOR_STORE_ID`

#### 2. Frontend (`public/index.html`)
- Single-page application with real-time chat interface
- Firebase authentication and real-time message listeners
- Enhanced markdown formatting for ACIM responses
- Quick action buttons for common spiritual guidance

#### 3. Local Testing (`main.py`)
- Direct OpenAI Assistant interaction for development
- Command-line interface for testing CourseGPT responses
- Structured logging and error handling

#### 4. Agent System (`agents/`)
- Specialized AI agents for autonomous development
- Core agents: ACIM Scholar, Product Manager, Backend Engineer
- Templates and registry for agent management

### Data Architecture

#### Firestore Collections
- **`users`**: User profiles with OpenAI thread IDs
- **`messages`**: Chat history with real-time updates
- **`rateLimits`**: User rate limiting and token usage tracking

#### ACIM Knowledge Base
- **`/data/CourseGPT.md`**: Core system prompt
- **`/data/A_Course_In_Miracles_Urtext.pdf`**: Complete ACIM text
- **Vector Store**: OpenAI embeddings for semantic search

### Development Workflow Guidelines

#### Working with Firebase Functions
- Always test locally with emulators before deployment
- Monitor function logs during development: `firebase functions:log`
- Environment variables are configured via `firebase functions:config:set`

#### OpenAI Assistant Management
- Assistant configuration is managed through `manage_assistant.py`
- ACIM knowledge base is stored in OpenAI Vector Store
- Each user gets a persistent conversation thread

#### Firestore Security
- Anonymous authentication required for all operations
- User data is isolated by `userId` in security rules
- Real-time listeners filter by authenticated user

#### Code Style Requirements
- **JavaScript**: ESLint with Google config for functions
- **Python**: Structured logging with environment-based log levels
- **HTML/CSS**: Responsive design with Firebase SDK integration

### Important Notes from Windsurf Rules
- **Always summarize, plan, and confirm** before making destructive changes
- **Search official docs first** before making assumptions
- **Be concise** - minimize fluff, provide copy-pastable commands
- **Never store secrets** in code or memory
- **Include exact citations** when referencing documentation

### Environment Configuration
Required environment variables:
```bash
# OpenAI Configuration
OPENAI_API_KEY=your_openai_api_key_here
ASSISTANT_ID=asst_coursegpt_id  # Generated by manage_assistant.py

# Optional
VECTOR_STORE_ID=vs_acim_knowledge
DAILY_OUT_TOKENS_CAP=2000
LOG_LEVEL=INFO
```

Firebase configuration is handled via `firebase.json` with hosting, functions, and Firestore rules.